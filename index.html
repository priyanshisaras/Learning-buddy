<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lecture Bot Assistant</title>
  <style>
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    .video-container {
      max-width: 960px;
      margin: 20px auto;
      background-color: #000;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.7);
    }

    video {
      width: 100%;
      height: auto;
      border-radius: 8px;
    }

    /* Chat toggle button */
    #chat-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1001;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    /* Chat container */
    #chat-container {
        display: none;
        position: fixed;
        bottom: 80px;
        right: 20px;
        width: 320px;
        height: 400px;
        min-width: 250px;
        min-height: 200px;
        background-color: #1e1e1e;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        resize: both;
        overflow: auto;
        z-index: 1000;
        flex-direction: column; /* keep this for layout when flex is enabled */
    }


    #chat-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
    }

    .message {
      margin: 8px 0;
      padding: 8px 12px;
      border-radius: 12px;
      max-width: 80%;
      display: inline-block;
    }

    .message.user {
      background-color: #383838;
      align-self: flex-end;
    }

    .message.bot {
      background-color: #2a2a2a;
      align-self: flex-start;
    }

    #chat-form {
      display: flex;
      border-top: 1px solid #444;
    }

    #user-input {
      flex: 1;
      padding: 10px;
      background-color: #333;
      color: #e0e0e0;
      border: none;
    }

    #user-input:focus {
      outline: none;
    }

    #send-button {
      background-color: #4a4a4a;
      color: #e0e0e0;
      border: none;
      padding: 0 16px;
      cursor: pointer;
    }

    #send-button:hover {
      background-color: #5a5a5a;
    }

    .jumping-dots span {
      display: inline-block;
      width: 8px;
      height: 8px;
      margin: 0 2px;
      background-color: #888;
      border-radius: 50%;
      animation: jump 1s infinite;
    }

    .jumping-dots .dot-1 { animation-delay: 0s; }
    .jumping-dots .dot-2 { animation-delay: 0.2s; }
    .jumping-dots .dot-3 { animation-delay: 0.4s; }

    @keyframes jump {
      0%, 60% { transform: translateY(0); }
      30% { transform: translateY(-6px); }
    }
  </style>
</head>
<body>

  <!-- Centered video -->
  <div class="video-container">
    <video id="lectureVideo" controls>
      <source src="RAG.mp4" type="video/mp4">
      Your browser does not support HTML video.
    </video>
  </div>

  <!-- Chat Widget Toggle Button -->
  <button id="chat-toggle">ðŸ’¬</button>

  <!-- Chat Container -->
  <div id="chat-container">
    <div id="chat-messages"></div>
    <form id="chat-form">
      <input id="user-input" type="text" placeholder="Ask a question..." />
      <button id="send-button" type="submit">Send</button>
    </form>
  </div>

  <!-- Inside <script> tag at the end of your current HTML -->
<script>
  const video = document.getElementById('lectureVideo');
  const chatToggle = document.getElementById('chat-toggle');
  const chatContainer = document.getElementById('chat-container');
  const chatMessages = document.getElementById('chat-messages');
  const chatForm = document.getElementById('chat-form');
  const userInput = document.getElementById('user-input');

  // Track pause timestamps
  let pauseTimestamps = [];
  let pauseTimer = null;
  let pauseDataSent = false;

  // Toggle chat visibility
  chatToggle.addEventListener('click', () => {
    const isVisible = chatContainer.style.display === 'flex';
    if (isVisible) {
        chatContainer.style.display = 'none';
    } else {
        chatContainer.style.display = 'flex';
        video.pause();  // Pause video when opening chat
    }
    });


  chatForm.addEventListener('submit', function (e) {
    e.preventDefault();
    const query = userInput.value.trim();
    const timeSec = Math.floor(video.currentTime);
    if (!query) return;

    appendMessage(query, 'user');
    userInput.value = '';
    appendThinking();

    fetch('http://127.0.0.1:8000/items/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query: query,
        time_stamp: timeSec,
        collection_name: 'butter'
      })
    })
    .then(res => res.json())
    .then(data => {
      removeThinking();
      appendMessage(data["reponse by gemini"] || "No response from bot", 'bot');
    })
    .catch(err => {
      removeThinking();
      appendMessage("Error contacting backend.", 'bot');
      console.error(err);
    });
  });

  function appendMessage(text, sender) {
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('message', sender);
    msgDiv.textContent = text;
    chatMessages.appendChild(msgDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function appendThinking() {
    const thinkingDiv = document.createElement('div');
    thinkingDiv.classList.add('message', 'bot');
    thinkingDiv.id = 'thinking';
    thinkingDiv.innerHTML = 'Bot is thinking <span class="jumping-dots"><span class="dot-1"></span><span class="dot-2"></span><span class="dot-3"></span></span>';
    chatMessages.appendChild(thinkingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function removeThinking() {
    const thinking = document.getElementById('thinking');
    if (thinking) thinking.remove();
  }


  video.addEventListener('pause', () => {
    if (pauseTimer) clearTimeout(pauseTimer);
    pauseTimer = setTimeout(() => {
      if (video.paused) {
        const time = parseFloat(video.currentTime.toFixed(3));
        if (!pauseTimestamps.includes(time)) {
          pauseTimestamps.push(time);
          console.log('Recorded pause at', time, 'seconds');
        }
      }
    }, 5000);
  });

  video.addEventListener('play', () => {
    if (pauseTimer) {
      clearTimeout(pauseTimer);
      pauseTimer = null;
    }
  });

  video.addEventListener('timeupdate', () => {
    if (!pauseDataSent && (video.duration - video.currentTime <= 10)) {
      if (pauseTimestamps.length > 0) {
        fetch('http://127.0.0.1:8000/pauses/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pauses: pauseTimestamps })
        })
        .then(res => res.json())
        .then(data => {
          console.log('Pause data sent:', data);
        })
        .catch(err => {
          console.error('Error sending pause data:', err);
        });
      }
      pauseDataSent = true;
    }
  });
</script>
</body>
</html>
